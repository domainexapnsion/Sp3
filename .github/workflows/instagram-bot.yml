# FILE: .github/workflows/instagram-bot.yml
# This is the final, corrected workflow.

name: Instagram DM Repost Bot

on:
  schedule:
    # Runs automatically every 4 hours.
    - cron: '0 */4 * * *'
  workflow_dispatch:
    # Allows you to run it manually from the Actions tab.

jobs:
  repost-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ⬇️ Checkout repository
        uses: actions/checkout@v4

      - name: 🐍 Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip' # Speeds up future runs by caching packages

      - name: 📦 Install Python packages
        run: pip install instagrapi requests

      - name: 🔑 Restore Instagram Session from Secret
        # This is the crucial step that uses your secret.
        # It MUST match the name you set in Step 1.
        env:
          IG_SESSION_DATA: ${{ secrets.IG_SESSION_DATA }}
        run: |
          echo "Restoring session from secret..."
          if [ -z "$IG_SESSION_DATA" ]; then
            echo "❌ Error: IG_SESSION_DATA secret is not set. Terminating."
            exit 1
          else
            echo "$IG_SESSION_DATA" | base64 --decode > session.json
            echo "✅ session.json file created successfully."
          fi

      - name: 🤖 Run the Repost Bot
        # Provides the username/password as a fallback, though the session should be used first.
        env:
          INSTAGRAM_USERNAME: ${{ secrets.INSTAGRAM_USERNAME }}
          INSTAGRAM_PASSWORD: ${{ secrets.INSTAGRAM_PASSWORD }}
        run: python repost_bot.py
