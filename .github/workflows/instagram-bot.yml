# GitHub Actions workflow to repost Instagram DMs
# This workflow is scheduled to run every 4 hours and can be triggered manually.

name: Instagram DM Repost Bot

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

jobs:
  repost-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    container:
      image: python:3.11-slim-bullseye
      volumes:
        - ${{ github.workspace }}:/app
      options: --user root
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y \
            build-essential \
            libjpeg-dev \
            zlib1g-dev \
            libwebp-dev \
            libtiff5-dev \
            libopenjp2-7-dev \
            libfreetype6-dev \
            libffi-dev \
            libssl-dev \
            libraqm-dev

      - name: Install Python packages
        run: |
          # Safely remove a potentially incorrect package to prevent conflicts.
          pip uninstall -y instagram || true
          
          # Force a fresh reinstallation of all packages.
          # This should fix the 'AttributeError' by ensuring the instagrapi package is not corrupted.
          pip install --no-cache-dir --upgrade --force-reinstall \
            instagrapi \
            requests \
            pydantic \
            python-dotenv \
            pillow

      - name: Verify installation
        run: |
          python -c "from PIL import Image; print(f'Pillow version: {Image.__version__}')"
          # This check should now pass after the corrected installation.
          python -c "import instagrapi; print(f'instagrapi version: {instagrapi.__version__}')"

