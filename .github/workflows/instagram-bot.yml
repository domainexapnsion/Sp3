name: Instagram DM Repost Bot

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

jobs:
  repost-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install system dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            build-essential \
            python3-dev \
            libjpeg-dev \
            zlib1g-dev \
            libwebp-dev \
            libtiff5-dev \
            libopenjp2-7-dev \
            libfreetype6-dev \
            libffi-dev \
            libssl-dev \
            pkg-config
          
      - name: Clean pip cache and install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip cache purge
          pip install --no-cache-dir --force-reinstall Pillow==10.0.1
          pip install --no-cache-dir instagrapi==1.16.34
          pip install --no-cache-dir requests pydantic python-dotenv
          
      - name: Verify core imports only
        run: |
          python -c "import sys; print('Python version:', sys.version)"
          python -c "import PIL; print('PIL imported successfully')"
          python -c "from PIL import Image; print('PIL.Image imported successfully')"
          
      - name: Create required files
        run: |
          touch bot.log
          echo "[]" > processed_messages.json
          
      - name: Run Instagram repost bot
        env:
          INSTAGRAM_USERNAME: ${{ secrets.INSTAGRAM_USERNAME }}
          INSTAGRAM_PASSWORD: ${{ secrets.INSTAGRAM_PASSWORD }}
          PYTHONPATH: ${{ github.workspace }}
          PYTHONUNBUFFERED: 1
        run: |
          timeout 900 python bot.py 2>&1 | tee -a bot.log || echo "Bot execution completed"
          
      - name: Show execution results
        if: always()
        run: |
          echo "=== BOT LOG ==="
          if [ -f bot.log ]; then
            cat bot.log
          else
            echo "No bot.log file found"
          fi
          echo -e "\n=== PROCESSED MESSAGES ==="
          if [ -f processed_messages.json ]; then
            cat processed_messages.json
          else
            echo "No processed_messages.json file found"
          fi
          
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bot-logs-${{ github.run_number }}
          path: |
            bot.log
            processed_messages.json
          retention-days: 7
          if-no-files-found: ignore
          
      - name: Clean up sensitive files
        if: always()
        run: |
          rm -f session.json 2>/dev/null || true