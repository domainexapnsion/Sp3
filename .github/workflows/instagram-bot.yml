name: Instagram DM Repost Bot

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

jobs:
  repost-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install ALL system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            python3-dev \
            python3-pip \
            python3-setuptools \
            python3-venv \
            libjpeg-dev \
            zlib1g-dev \
            libwebp-dev \
            libtiff5-dev \
            libopenjp2-7-dev \
            libfreetype6-dev \
            libffi-dev \
            libssl-dev \
            libraqm-dev \
            liblcms2-dev \
            libimagequant-dev \
            libxcb1-dev
          
      - name: Create clean Python environment
        run: |
          python -m venv --system-site-packages /opt/venv
          source /opt/venv/bin/activate
          
      - name: Install Pillow from source
        run: |
          source /opt/venv/bin/activate
          pip install --upgrade pip setuptools wheel cython
          pip uninstall -y pillow || true
          rm -rf Pillow || true
          git clone --depth=1 https://github.com/python-pillow/Pillow.git
          cd Pillow
          python setup.py install --force
          cd ..
          
      - name: Install other packages
        run: |
          source /opt/venv/bin/activate
          pip install --no-cache-dir \
            instagrapi \
            requests \
            pydantic \
            python-dotenv
          
      - name: Verify installation
        run: |
          source /opt/venv/bin/activate
          echo "=== Pillow Verification ==="
          python -c "from PIL import Image; print(f'Pillow version: {Image.__version__}'); print('Pillow features:', Image.features.check('raqm', 'webp', 'jpeg2000', 'freetype2'))"
          echo "=== Instagrapi Verification ==="
          python -c "import instagrapi; print(f'instagrapi version: {instagrapi.__version__}')"
          echo "=== All Installed Packages ==="
          pip list
          
      - name: Create required files
        run: |
          touch bot.log
          echo "[]" > processed_messages.json
          
      - name: Run Instagram repost bot
        env:
          INSTAGRAM_USERNAME: ${{ secrets.INSTAGRAM_USERNAME }}
          INSTAGRAM_PASSWORD: ${{ secrets.INSTAGRAM_PASSWORD }}
          PYTHONPATH: ${{ github.workspace }}
          PYTHONUNBUFFERED: 1
        run: |
          source /opt/venv/bin/activate
          timeout 900 python bot.py || echo "Bot completed or timed out"
          
      - name: Show bot logs
        if: always()
        run: |
          echo "=== BOT LOG ==="
          cat bot.log || echo "No bot.log found"
          echo "=== PROCESSED MESSAGES ==="
          cat processed_messages.json || echo "No processed_messages.json found"
          
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bot-logs-${{ github.run_number }}
          path: |
            bot.log
            processed_messages.json
          retention-days: 7
          
      - name: Clean up
        if: always()
        run: |
          rm -f session.json || true
          rm -f *.log || true